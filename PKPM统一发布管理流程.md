# PKPM统一发布管理流程

## Feature

### 主页面

默认通过网址或IP直接访问的页面，其逻辑如下：

- 当没有任何版本，且也没有配置文件表的时候，就上传一个配置文件表([跳转到User Story](#上传一个配置文件表))
  ![](PKPM统一发布管理流程/当不存在任何版本也不存在配置文件表时上传一个配置文件表.png)
- 当没有任何版本，但有配置文件表，就要求按照该配置文件表上传文件([跳转到User Story](#上传第一个版本))
  ![](PKPM统一发布管理流程/当不存在任何版本但有配置文件时按配置文件上传版本.png)
- 当有版本的时候，展示主页面。主页面包括：
  - 版本路线图
  - 配置文件修改
  - 新版本提交([跳转到User Story](#新版本提交))
    
    ![](PKPM统一发布管理流程/新版本提交.png)

### 配置文件表的增删查改

### 用户获得当前版本路径图

### 用户上传文件

- [IN] 用户名, 父版本号, 上传文件列表
- 根据父版本号可获得新建版本的配置文件列表
- 根据用户名可获得其所在项目组名 SELECT PROJECT_GROUP FROM TABLE WHERE STAFF_ID == 
- 在配置文件列表中筛选出该项目组负责的文件列表 SELECT PATH FROM TABLE WHERE PROJECT_GROUP == ''
- 将上传文件列表和筛选后的文件列表对比，筛选出该用户上传的有效文件列表
- 获得父版本所有的文件列表和哈希值
- 对比该用户上传的有效文件列表和父版本的文件列表，获得新增状态
- 保存新增状态，新建版本
- 按照版本管理保存对应文件

### 用户修改配置文件

### 用户取消修改配置文件

### 流程

![](PKPM统一发布管理流程/内网上传文件时序图.png)

## 版本管理

- 若某个版本节点上存在下个版本的配置文件列表，则基于该版本节点新建版本必须按照指定的版本文件列表
  - 当新建版本结束后，该版本节点的下个版本配置文件列表应置空
- 若某个版本节点上下个版本的配置文件列表为空，则基于该版本节点新建版本就按照该版本节点使用的版本文件列表
- 版本一旦新建，无法回退，只能通过再次上传达到回退的目的

## 数据库管理

数据库应该包含以下几张表

- 所有版本列表
  - 版本号ID是INT，每个版本号ID有个名为"VERSION_版本号ID"的表来查看详细信息
  - 每个版本的子版本可以有多个，父版本只能有一个
  - 配置文件是以名字为key，所以不能有重名的配置文件
  - 版本号可以有别名，对应于发版的版本系统
  - 版本类型目前分为发行版、压盘版、测试版三级
  - 修改配置文件后，可以指定某个版本的下个版本必须用这个配置文件。默认当前版本的下个版本的配置文件和当前版本相同

| 版本号ID | 配置文件名 | parent_ver_ID  | child_ver_ID |  版本号别名 |  版本类型 |  指定下个版本xml文件 |
|---------|-----------|---------------|------------|-------------|----------|---------------------|
|  ver1   |  a.xml    |   null       |     ver2     |  null      |  type1   |       a.xml         |
|  ver2   |  a.xml    |   ver1       |     ver3     |  v4.1      |  type2   |       b.xml         |
|  ver3   |  b.xml    |   ver2       |     null     |  v4.1.1    |  type3   |       null          |

- 各项目组权限列表

| 项目组名  | 可上传文件 | 可编辑配置文件 |
| -----    |  :---:    |  :---:        |
| 产品设计组|  TRUE     |    TRUE       |

- 人员列表
  - 项目组决定了该人员的权限，一个人可以属于多个项目组，用分号分隔。
  - 状态有正常、已删除两种，已删除只有查看历史记录时有用

| 人员ID | 姓名 | 项目组名 | 状态 |
| -----  |:---:|:--------:|:---:|
|  1     | 肖丽 |  产品设计组  | 正常 |

- 配置文件表修改记录表

| 配置文件名 | 创建时间 | 提交人员 | 备注 |
| -----   |:--------:|:--------:|:--------:|
|  a.xml  |  2017-06-01  | 肖丽   |建模团队增加文件 |

- 配置文件表（每个配置文件一张表）
  - 配置文件表名需保证唯一性

| 文件路径 | 项目组名 |
| -----   |:--------:|
|  CFG/abc | 建模团队 |

- 版本信息表（每个版本相对上个版本的改动）
  - 状态包括“修改”、“添加”、“删除”

| 文件路径 | MD5 | 文件大小 | 状态 |
| -----   |:----:|:------:|:----:|
|  CFG/abc| 02605 | 12035 | 修改 |


## User Story

### <a id="上传一个配置文件表">上传一个配置文件表</a>

### <a id="上传第一个版本">上传第一个版本</a>

- 展示配置文件表
- 按照配置文件表的目录结构选择文件夹，上传整个文件夹
- 校核文件夹内文件和配置文件的匹配
- 上传整个文件夹
- 新建版本

### <a id="新版本提交">新版本提交</a>

- 主页面上点击”提交新版本“
  - 选择新版本基于的父版本、用户名、组
- 展示可上传的文件列表
  - 这点需要和用户名以及其分组相关
- 验证上传过程
  - 只有符合要求的文件才上传
  - 只有修改的文件才上传
- 上传形成新版本

### 内网服务器配置管理

- 能在不重启服务的情况下做一些配置
  - 修改登陆密码
  - 添加账号
  - 修改配置文件
  - 查看各版本备份结果
  - 查看数据库信息

### 内网研发人员登陆

- 登陆验证
  - 在网页端输入，POST服务器验证
- 返回其负责的配置文件
  - 验证成功了，返回对应的配置文件（和版本相关）
- 加锁，浏览版本信息时不需要登录信息，点击上传或其他操作后就需要登录，且登录状态下其他人无法操作，若操作则会给出提示

### 内网研发人员上传

- js按照配置文件过滤上传文件
- js计算上传文件md5，和上个版本比较，决定上传哪些文件
- 服务器按照配置文件过滤上传文件
- 服务器将新版本入库
  - 版本列表更新
  - 版本信息表更新
- 服务器加锁，让新建版本原子化

![](PKPM统一发布管理流程/内网上传文件时序图.png)

### 内网产品经理修改配置文件

- 内网允许某些用户修改配置文件
- 配置文件修改时要加锁
- 配置文件修改后，新版本生成要符合配置文件。比如配置文件增加了文件，那再上传文件时，该文件必须上传。但这点需要按模块来考虑
- 修改配置文件需要记录提交原因，提交人员。

### 内网李守功标记版本类型

- 允许指定某版本的版本类型

### 获取某版本文件

- 根据任意两个版本计算出需要改变哪些差异文件
- 根据用户电脑上文件判断出属于哪个版本
- 自动生成某版本的文件列表及其MD5值
- 帮助用户根据电脑上文件状态，获取到某个版本

### log记录

### 出错处理

### 中文路径处理

### 上锁处理